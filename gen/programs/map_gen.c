#include <stdio.h>
#include <unistr.h>
#include <inttypes.h>

#define NTWT_SHORT_NAMES
#include "../../shared/hash/hashmap.h"
#include "../../shared/vm/vm.h"

#define MAP_ADD_OP(MAP, KEY, STORAGE)					\
	hashmap_add(MAP, KEY, sizeof(KEY) - 1, &(char){ STORAGE })	\

static int compare(const void *entry_key, uint32_t entry_key_size,
		   const void *key, uint32_t key_size)
{
	if (entry_key_size != key_size)
		return 0;
	else
		return !u8_strncmp(key, entry_key, key_size);
}

static void free_contents(void *key, void *storage) {

}

static void map_write(struct ntwt_hashmap *map, FILE *output)
{
	struct ntwt_hashbin *bin = map->bins;

	fprintf(output, "%s%u%s%i",
		"\n.bin_num = ", map->bin_num,
		",\n.entry_num = ", map->entry_num);
	fprintf(output,
		",\n.primes_pointer = &(int) { %i }",
		*map->primes_pointer);
	fprintf(output,
		",\n.bins = (struct ntwt_hashbin[%i]) {",
		map->bin_num);

	int i;

	for (i = 0; i != map->bin_num; ++i, ++bin) {
		int entry_num = 0;
		struct ntwt_hashentry *entry = bin->first;

		fprintf(output,
			"\n\t[%i].first = ", i);
		for (; entry; entry = entry->next) {
			++entry_num;
			fprintf(output, "&(struct ntwt_hashentry) {");
			fprintf(output, "\n\t\t.key = u8\"%s\"", entry->key);
			fprintf(output, ",\n\t\t.key_size = %"PRIu32,
				entry->key_size);
			fprintf(output,
				",\n\t\t.storage = &(char) { %i }",
				*(char *) entry->storage);
			fprintf(output, ",\n\t\t.next = ");
		}
		fprintf(output, "NULL");
		for (; entry_num; --entry_num)
			fprintf(output, "}");
		fprintf(output, ",");
	}
	fprintf(output, "\n}\n");
}

int main(int argc, char **args)
{
	remove("../output/op_map.c");

	FILE *output = fopen("op_map.c", "ab");
	struct ntwt_hashmap *map = hashmap_new(0, compare, free_contents);

	fprintf(output, "%s",
		"/* DO NOT EDIT THIS FILE, IT IS GENERATED! */\n"
		"/* AND RATHER POORLY AT THAT, I MEAN I SHOULD FIX THIS! */\n"
		"/* THIS IS A PRIME EXAMPLE OF PREMATURE OPTIMIZATION. */\n"
		"/* ALL TO SAVE SOME RUN TIME MEMORY ALLOCATION... */\n"
		"/* STILL WORTH IT! */\n"
		"#include <stdio.h>\n"
		"#include <stdlib.h>\n"
		"#include <unistr.h>\n"
		"#include \"op_map.h\"\n"
		"#include \"../input/op_map_opener.c\"\n");
	MAP_ADD_OP(map, u8"TEST", NTWT_OP_TEST);
	MAP_ADD_OP(map, u8"END", NTWT_OP_END);
	MAP_ADD_OP(map, u8"ECHO", NTWT_OP_ECHO);
	MAP_ADD_OP(map, u8"EXEC", NTWT_OP_EXEC);
	MAP_ADD_OP(map, u8"SAVE", NTWT_OP_SAVE);

	map_write(map, output);
	fprintf(output, "\n#include \"../input/op_map_closer.c\"\n");

	hashmap_free(map);
	fclose(output);

	return 0;
}
